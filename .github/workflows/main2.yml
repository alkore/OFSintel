name: CMake (macOS Intel — direct CMake + embedded mpv)

on:
  workflow_dispatch:
  push:
  pull_request:

env:
  BUILD_TYPE: Release

jobs:
  macos:
    runs-on: macos-15-intel   # runner Intel x86_64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Show architecture
        run: |
          echo "uname -m: $(uname -m)"
          sysctl -n machdep.cpu.brand_string || true
          sw_vers

      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config mpv

      - name: Clean previous builds
        run: rm -rf build bin CMakeFiles CMakeCache.txt || true

      # === Configure/Build en x86_64 natif ===
      - name: Configure CMake (Intel x86_64)
        run: |
          set -euo pipefail
          HB_PREFIX="$(brew --prefix)"
          echo "Homebrew prefix: $HB_PREFIX"
          export PKG_CONFIG_PATH="$HB_PREFIX/lib/pkgconfig:$HB_PREFIX/share/pkgconfig:${PKG_CONFIG_PATH:-}"
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: Build OFS (Intel)
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target OpenFunscripter -j

      # === Localiser l'app ===
      - name: Locate app bundle
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="$(find build -type d -name 'OpenFunscripter.app' -print -quit || true)"
          if [ -z "$APP_PATH" ]; then
            APP_PATH="$(find . -maxdepth 4 -type d -name 'OpenFunscripter.app' -print -quit || true)"
          fi
          if [ -z "$APP_PATH" ]; then
            echo "OpenFunscripter.app introuvable"; exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"
          echo "Found: $APP_PATH"

      # === Embarquer la vraie lib mpv versionnée (libmpv.N.dylib) ===
      - name: Embed libmpv into app
        run: |
          set -euo pipefail
          BREW_LIB_PATH="$(brew --prefix)/lib"
          MPV_REAL="$(ls "$BREW_LIB_PATH"/libmpv*.dylib | grep -E 'libmpv\.[0-9]+\.dylib' | head -n1 || true)"
          if [ -z "$MPV_REAL" ]; then
            echo "libmpv not found in $BREW_LIB_PATH"; exit 1
          fi
          mkdir -p "$APP_PATH/Contents/Frameworks"
          cp "$MPV_REAL" "$APP_PATH/Contents/Frameworks/"
          BASENAME="$(basename "$MPV_REAL")"
          install_name_tool -change "$MPV_REAL" \
            "@executable_path/../Frameworks/$BASENAME" \
            "$APP_PATH/Contents/MacOS/OpenFunscripter"

      - name: Inspect binary arch (should be x86_64)
        run: |
          BIN="$APP_PATH/Contents/MacOS/OpenFunscripter"
          file "$BIN" || true
          otool -hv "$BIN" | head -n1 || true

      - name: Package app (zip)
        run: ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "OpenFunscripter-macOS-Intel.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: OFS-macOS-Intel
          path: OpenFunscripter-macOS-Intel.zip
          retention-days: 14
