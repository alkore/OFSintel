name: CMake (macOS Intel â€” mpv via Homebrew + vendoring complet)

on:
  workflow_dispatch:
  push:
  pull_request:

env:
  BUILD_TYPE: Release

jobs:
  macos:
    runs-on: macos-15-intel   # Intel x86_64 runner

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Show architecture
        run: |
          echo "uname -m: $(uname -m)"
          sysctl -n machdep.cpu.brand_string || true
          sw_vers

      - name: Install base dependencies (with mpv)
        shell: bash
        run: |
          set -euo pipefail
          brew update || true
          # Install mpv + typical deps; do NOT silence errors here
          brew install cmake pkg-config ffmpeg libass zimg glib pcre2 libplacebo mpv || true
          echo "== Brew list =="
          brew list --versions ffmpeg mpv libass zimg glib pcre2 libplacebo || true

      - name: Ensure libmpv present (reinstall/build-from-source if needed)
        shell: bash
        run: |
          set -euo pipefail
          BREW_PREFIX="$(brew --prefix)"
          echo "BREW_PREFIX=$BREW_PREFIX"

          # Helper: try to locate libmpv in multiple places
          find_libmpv() {
            # via pkg-config (mpv or libmpv)
            for pkg in mpv libmpv; do
              if PKGDIR="$(pkg-config --variable=libdir "$pkg" 2>/dev/null)"; then
                for P in "$PKGDIR"/libmpv*.dylib; do [ -f "$P" ] && echo "$P" && return 0; done
              fi
            done
            # Homebrew "opt" and "lib"
            for P in \
              "$BREW_PREFIX/opt/mpv/lib/libmpv.dylib" \
              "$BREW_PREFIX/lib/libmpv.dylib" \
              $(ls "$BREW_PREFIX"/lib/libmpv*.dylib 2>/dev/null || true) ; do
              [ -f "$P" ] && echo "$P" && return 0
            done
            # Homebrew Cellar real path
            for P in $(ls "$BREW_PREFIX"/Cellar/mpv/*/lib/libmpv*.dylib 2>/dev/null || true); do
              [ -f "$P" ] && echo "$P" && return 0
            done
            # As a last resort, inspect brew ls mpv file list
            if brew ls -v mpv >/tmp/brew_ls_mpv.txt 2>/dev/null; then
              awk '{print NF? $0: ""}' /tmp/brew_ls_mpv.txt | grep -E 'libmpv.*\.dylib$' || true
            fi
          }

          LIBMPV_PATH="$(find_libmpv || true)"
          if [ -z "$LIBMPV_PATH" ]; then
            echo "libmpv not found after initial install. Forcing a reinstall from source..."
            brew reinstall -s mpv
            sleep 2
            LIBMPV_PATH="$(find_libmpv || true)"
          fi

          echo "---- debug ----"
          echo "brew --prefix mpv: $(brew --prefix mpv || true)"
          brew info mpv || true
          echo "Candidate LIBMPV_PATH: ${LIBMPV_PATH:-<none>}"
          echo "Listing /usr/local/lib for libmpv:"
          ls -la /usr/local/lib | grep -i libmpv || true
          echo "Listing Cellar mpv lib folder:"
          find "$(brew --prefix)/Cellar/mpv" -name 'libmpv*.dylib' 2>/dev/null || true
          echo "----------------"

          if [ -z "$LIBMPV_PATH" ] || [ ! -f "$LIBMPV_PATH" ]; then
            echo "âŒ libmpv*.dylib introuvable aprÃ¨s (rÃ©)installation Homebrew."
            exit 1
          fi

          # Resolve symlink to the real file, export to env for next steps
          LIBMPV_REAL="$(stat -f %Y "$LIBMPV_PATH" 2>/dev/null || echo "$LIBMPV_PATH")"
          echo "LIBMPV_PATH=$LIBMPV_REAL" >> "$GITHUB_ENV"
          echo "âœ… Using LIBMPV_PATH=$LIBMPV_REAL"

      - name: Clean previous builds
        run: rm -rf build bin CMakeFiles CMakeCache.txt || true

      # === Configure/Build en x86_64 natif ===
      - name: Configure CMake (Intel x86_64)
        run: |
          set -euo pipefail
          HB_PREFIX="$(brew --prefix)"
          echo "Homebrew prefix: $HB_PREFIX"
          export PKG_CONFIG_PATH="$HB_PREFIX/lib/pkgconfig:$HB_PREFIX/share/pkgconfig:${PKG_CONFIG_PATH:-}"
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: Build OFS (Intel)
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target OpenFunscripter -j

      # === Localiser l'app ===
      - name: Locate app bundle
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="$(find build -type d -name 'OpenFunscripter.app' -print -quit || true)"
          if [ -z "$APP_PATH" ]; then
            APP_PATH="$(find . -maxdepth 5 -type d -name 'OpenFunscripter.app' -print -quit || true)"
          fi
          if [ -z "$APP_PATH" ]; then
            echo "OpenFunscripter.app introuvable"; exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"
          echo "Found: $APP_PATH"

      # === Vendoring libmpv et TOUTES les deps Homebrew (BFS) ===
      - name: Vendor libmpv and ALL Homebrew deps into app
        shell: bash
        run: |
          set -euo pipefail
          BREW_PREFIX="$(brew --prefix)"
          DEST="$APP_PATH/Contents/Frameworks"
          mkdir -p "$DEST"

          if [ -z "${LIBMPV_PATH:-}" ] || [ ! -f "$LIBMPV_PATH" ]; then
            echo "âŒ LIBMPV_PATH absent. Ã‰tape prÃ©cÃ©dente a Ã©chouÃ©."
            exit 1
          fi
          echo "âœ… Root dylib: $LIBMPV_PATH"
          otool -L "$LIBMPV_PATH" || true

          queue=("$LIBMPV_PATH")
          copied_set=""

          in_set() { case " $copied_set " in *" $1 "*) return 0;; *) return 1;; esac; }
          add_set() { copied_set="$copied_set $1"; }

          copy_if_needed() {
            local SRC="$1"
            local BASE="$(basename "$SRC")"
            local TGT="$DEST/$BASE"
            if [ ! -f "$TGT" ]; then
              REAL="$(stat -f %Y "$SRC" 2>/dev/null || echo "$SRC")"
              cp "$REAL" "$TGT"
              chmod 644 "$TGT" || true
              install_name_tool -id "@executable_path/../Frameworks/$BASE" "$TGT"
              echo "ðŸ“¦ Copied $BASE"
            fi
            echo "$TGT"
          }

          deps_of() {
            # Vendoriser uniquement les libs rÃ©sidant sous Homebrew (opt/lib/Cellar)
            otool -L "$1" \
              | awk 'NR>1 {print $1}' \
              | grep -E "^($(brew --prefix)/(opt|lib|Cellar)/)" || true
          }

          relink_dep() {
            local HOLDER="$1"
            local OLD="$2"
            local BASE="$(basename "$OLD")"
            install_name_tool -change "$OLD" "@executable_path/../Frameworks/$BASE" "$HOLDER"
          }

          while [ ${#queue[@]} -gt 0 ]; do
            SRC="${queue[0]}"; queue=("${queue[@]:1}")
            SRC_REAL="$(stat -f %Y "$SRC" 2>/dev/null || echo "$SRC")"
            if in_set "$SRC_REAL"; then continue; fi
            add_set "$SRC_REAL"

            TGT="$(copy_if_needed "$SRC_REAL")"
            echo "ðŸ”— Relinking deps for $(basename "$TGT")"

            while IFS= read -r DEP; do
              [ -n "$DEP" ] || continue
              echo "  - dep: $DEP"
              relink_dep "$TGT" "$DEP"
              case "$DEP" in
                *.dylib)
                  REAL="$(stat -f %Y "$DEP" 2>/dev/null || echo "$DEP")"
                  queue+=("$REAL")
                  ;;
              esac
            done < <(deps_of "$TGT")
          done

          MPV_BASE="$(basename "$LIBMPV_PATH")"
          install_name_tool -change "$LIBMPV_PATH" "@executable_path/../Frameworks/$MPV_BASE" "$APP_PATH/Contents/MacOS/OpenFunscripter"
          echo "âœ… Relinked main binary -> $MPV_BASE"

          # Fail fast si rien
          if [ -z "$(ls -A "$DEST" 2>/dev/null)" ]; then
            echo "âŒ Aucune dylib copiÃ©e dans Frameworks â€” vendoring a Ã©chouÃ©."; exit 1
          fi

      - name: Verify & list Frameworks
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ“‚ Listing $APP_PATH/Contents/Frameworks:"
          ls -la "$APP_PATH/Contents/Frameworks" || true
          echo ""
          echo "ðŸ”Ž Checking for Homebrew absolute paths..."
          OFFENDERS=0
          check_one() {
            local F="$1"
            if otool -L "$F" | awk 'NR>1{print $1}' | grep -q "^$(brew --prefix)/"; then
              echo "âŒ Still links to Homebrew: $F"
              otool -L "$F" | awk 'NR>1{print $1}' | grep "^$(brew --prefix)/"
              OFFENDERS=1
            fi
          }
          check_one "$APP_PATH/Contents/MacOS/OpenFunscripter"
          for F in "$APP_PATH/Contents/Frameworks/"*.dylib; do
            [ -f "$F" ] && check_one "$F"
          done
          if [ $OFFENDERS -ne 0 ]; then
            echo "Certaines libs pointent encore vers Homebrew â€” voir la liste ci-dessus."; exit 1
          else
            echo "âœ… Aucun chemin Homebrew absolu restant. Bundle autonome."
          fi

      - name: Create launcher (set DYLD_FALLBACK_LIBRARY_PATH)
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="$APP_PATH/Contents/MacOS"
          REAL="$BIN_DIR/OpenFunscripter.real"
          mv "$BIN_DIR/OpenFunscripter" "$REAL" || true
          {
            echo '#!/bin/bash'
            echo 'APPDIR="$(cd "$(dirname "$0")" && pwd)"'
            echo 'export DYLD_FALLBACK_LIBRARY_PATH="$APPDIR/../Frameworks${DYLD_FALLBACK_LIBRARY_PATH:+:$DYLD_FALLBACK_LIBRARY_PATH}"'
            echo 'exec "$APPDIR/OpenFunscripter.real" "$@"'
          } > "$BIN_DIR/OpenFunscripter"
          chmod +x "$BIN_DIR/OpenFunscripter"

      - name: Inspect binary arch (should be x86_64)
        run: |
          BIN="$APP_PATH/Contents/MacOS/OpenFunscripter"
          file "$BIN" || true
          otool -hv "$BIN" | head -n1 || true

      - name: Package app (zip)
        run: ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "OpenFunscripter-macOS-Intel.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: OFS-macOS-Intel
          path: OpenFunscripter-macOS-Intel.zip
          retention-days: 14
