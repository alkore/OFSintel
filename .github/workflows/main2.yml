name: CMake (macOS Intel — direct CMake + embedded mpv)

on:
  workflow_dispatch:
  push:
  pull_request:

env:
  BUILD_TYPE: Release

jobs:
  macos:
    runs-on: macos-15-intel   # runner Intel x86_64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Show architecture
        run: |
          echo "uname -m: $(uname -m)"
          sysctl -n machdep.cpu.brand_string || true
          sw_vers

      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config mpv

      - name: Clean previous builds
        run: rm -rf build bin CMakeFiles CMakeCache.txt || true

      # === Configure/Build en x86_64 natif ===
      - name: Configure CMake (Intel x86_64)
        run: |
          set -euo pipefail
          HB_PREFIX="$(brew --prefix)"
          echo "Homebrew prefix: $HB_PREFIX"
          export PKG_CONFIG_PATH="$HB_PREFIX/lib/pkgconfig:$HB_PREFIX/share/pkgconfig:${PKG_CONFIG_PATH:-}"
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: Build OFS (Intel)
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target OpenFunscripter -j

      # === Localiser l'app ===
      - name: Locate app bundle
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="$(find build -type d -name 'OpenFunscripter.app' -print -quit || true)"
          if [ -z "$APP_PATH" ]; then
            APP_PATH="$(find . -maxdepth 4 -type d -name 'OpenFunscripter.app' -print -quit || true)"
          fi
          if [ -z "$APP_PATH" ]; then
            echo "OpenFunscripter.app introuvable"; exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"
          echo "Found: $APP_PATH"

      - name: Vendor libmpv and deps into app (recursive)
        run: |
          set -euo pipefail
          BREW_PREFIX="$(brew --prefix)"
          BREW_LIB="$BREW_PREFIX/lib"
          DEST="$APP_PATH/Contents/Frameworks"
          mkdir -p "$DEST"

          # 1) Trouver la vraie libmpv.*.dylib
          MPV_REAL="$(ls "$BREW_LIB"/libmpv*.dylib | grep -E 'libmpv\.[0-9]+\.dylib' | head -n1 || true)"
          if [ -z "$MPV_REAL" ]; then
            echo "❌ libmpv.*.dylib introuvable sous $BREW_LIB"; exit 1
          fi
          echo "Found mpv dylib: $MPV_REAL"

          # 2) Fonction de copie + relink des dépendances Homebrew
          relink_one() {
            local FILE="$1"
            # Liste les dépendances dynamiques
            otool -L "$FILE" | awk 'NR>1 {print $1}' | grep -E "^$BREW_PREFIX/" || true
          }

          copy_and_relink() {
            local SRC="$1"
            local BASENAME="$(basename "$SRC")"
            local TARGET="$DEST/$BASENAME"

            # Copie si pas déjà là
            if [ ! -f "$TARGET" ]; then
              cp "$SRC" "$TARGET"
              chmod 644 "$TARGET" || true
              # Fixe l'install_name de la lib copiée
              install_name_tool -id "@executable_path/../Frameworks/$BASENAME" "$TARGET"
            fi

            # Pour chaque dépendance Homebrew de cette lib, copie + rewrite
            while IFS= read -r DEP; do
              local DEPNAME="$(basename "$DEP")"
              local DEPTARGET="$DEST/$DEPNAME"
              # Copie la dépendance si nécessaire
              if [ ! -f "$DEPTARGET" ]; then
                mkdir -p "$DEST"
                cp "$DEP" "$DEPTARGET"
                chmod 644 "$DEPTARGET" || true
                install_name_tool -id "@executable_path/../Frameworks/$DEPNAME" "$DEPTARGET"
              fi
              # Réécrit le chemin dans la lib courante
              install_name_tool -change "$DEP" "@executable_path/../Frameworks/$DEPNAME" "$TARGET"
            done < <(relink_one "$TARGET")
          }

          # 3) Copie/relink libmpv puis passe 2 fois sur les deps (closure grossière)
          copy_and_relink "$MPV_REAL"
          # Passe 2 fois pour attraper les deps de deps (ex: libass → freetype → zstd, etc.)
          for ROUND in 1 2; do
            for F in "$DEST"/*.dylib; do
              [ -f "$F" ] || continue
              while IFS= read -r DEP; do
                DEPNAME="$(basename "$DEP")"
                DEPTARGET="$DEST/$DEPNAME"
                if [ ! -f "$DEPTARGET" ]; then
                  cp "$DEP" "$DEPTARGET"
                  chmod 644 "$DEPTARGET" || true
                  install_name_tool -id "@executable_path/../Frameworks/$DEPNAME" "$DEPTARGET"
                fi
                install_name_tool -change "$DEP" "@executable_path/../Frameworks/$DEPNAME" "$F"
              done < <(otool -L "$F" | awk 'NR>1 {print $1}' | grep -E "^$BREW_PREFIX/" || true)
            done
          done

          # 4) Assure que l'exécutable principal pointe vers la bonne libmpv
          MPV_BASENAME="$(basename "$MPV_REAL")"
          install_name_tool -change "$MPV_REAL" "@executable_path/../Frameworks/$MPV_BASENAME" "$APP_PATH/Contents/MacOS/OpenFunscripter"

      - name: Create launcher (set DYLD_FALLBACK_LIBRARY_PATH)
        run: |
          set -euo pipefail
          BIN_DIR="$APP_PATH/Contents/MacOS"
          REAL="$BIN_DIR/OpenFunscripter.real"
          mv "$BIN_DIR/OpenFunscripter" "$REAL"

          {
            echo '#!/bin/bash'
            echo 'APPDIR="$(cd "$(dirname "$0")" && pwd)"'
            echo 'export DYLD_FALLBACK_LIBRARY_PATH="$APPDIR/../Frameworks${DYLD_FALLBACK_LIBRARY_PATH:+:$DYLD_FALLBACK_LIBRARY_PATH}"'
            echo 'exec "$APPDIR/OpenFunscripter.real" "$@"'
          } > "$BIN_DIR/OpenFunscripter"

          chmod +x "$BIN_DIR/OpenFunscripter"

      - name: Inspect binary arch (should be x86_64)
        run: |
          BIN="$APP_PATH/Contents/MacOS/OpenFunscripter"
          file "$BIN" || true
          otool -hv "$BIN" | head -n1 || true

      - name: Package app (zip)
        run: ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "OpenFunscripter-macOS-Intel.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: OFS-macOS-Intel
          path: OpenFunscripter-macOS-Intel.zip
          retention-days: 14
