name: CMake (macOS Intel6 — full self-contained build with libmpv)

on:
  workflow_dispatch:
  push:
  pull_request:

env:
  BUILD_TYPE: Release

jobs:
  macos:
    runs-on: macos-15-intel

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Show architecture
        run: |
          uname -m
          sysctl -n machdep.cpu.brand_string || true
          sw_vers

      - name: Install base dependencies
        run: |
          brew update
          brew install cmake pkg-config python@3.11 ninja ffmpeg libass

      # === Build libmpv from source (Intel) ===
      - name: Build libmpv (Intel)
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 https://github.com/mpv-player/mpv.git
          cd mpv
          mkdir build
          python3 ./waf configure --prefix=/usr/local --enable-libmpv-shared --disable-vulkan
          python3 ./waf build
          sudo python3 ./waf install
          ls -la /usr/local/lib | grep libmpv || true

      # === Configure and build OFS ===
      - name: Configure OFS (x86_64)
        run: |
          set -euo pipefail
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
      - name: Build OFS
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target OpenFunscripter -j

      # === Locate app bundle ===
      - name: Locate app bundle
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="$(find build -type d -name 'OpenFunscripter.app' -print -quit || true)"
          if [ -z "$APP_PATH" ]; then
            APP_PATH="$(find . -maxdepth 5 -type d -name 'OpenFunscripter.app' -print -quit || true)"
          fi
          if [ -z "$APP_PATH" ]; then
            echo "OpenFunscripter.app introuvable"; exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"
          echo "Found: $APP_PATH"

      # === Copy libmpv + deps ===
      - name: Copy libmpv and deps into Frameworks
        shell: bash
        run: |
          set -euo pipefail
          DEST="$APP_PATH/Contents/Frameworks"
          mkdir -p "$DEST"
          echo "Copying libmpv and dependencies…"
          cp /usr/local/lib/libmpv*.dylib "$DEST" || (echo "libmpv not found"; exit 1)
          for dep in libavcodec libavformat libswscale libavutil libass libfreetype libzstd libpcre2-8 libglib-2.0; do
            find /usr/local/lib -name "${dep}*.dylib" -exec cp {} "$DEST" \; 2>/dev/null || true
          done
          ls -la "$DEST"

      - name: Relink binaries to embedded libs
        shell: bash
        run: |
          set -euo pipefail
          BIN="$APP_PATH/Contents/MacOS/OpenFunscripter"
          for lib in "$APP_PATH/Contents/Frameworks/"*.dylib; do
            BASE="$(basename "$lib")"
            install_name_tool -change "/usr/local/lib/$BASE" "@executable_path/../Frameworks/$BASE" "$BIN" 2>/dev/null || true
          done
          echo "✅ Relinked binary with embedded libs."

      - name: Create launcher (set DYLD_FALLBACK_LIBRARY_PATH)
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="$APP_PATH/Contents/MacOS"
          REAL="$BIN_DIR/OpenFunscripter.real"
          mv "$REAL" "$REAL" 2>/dev/null || true
          mv "$BIN_DIR/OpenFunscripter" "$REAL" || true
          cat > "$BIN_DIR/OpenFunscripter" << 'EOF'
#!/bin/bash
APPDIR="$(cd "$(dirname "$0")" && pwd)"
export DYLD_FALLBACK_LIBRARY_PATH="$APPDIR/../Frameworks${DYLD_FALLBACK_LIBRARY_PATH:+:$DYLD_FALLBACK_LIBRARY_PATH}"
exec "$APPDIR/OpenFunscripter.real" "$@"
EOF
          chmod +x "$BIN_DIR/OpenFunscripter"

      - name: Inspect Frameworks
        run: ls -la "$APP_PATH/Contents/Frameworks"

      - name: Package app
        run: ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "OpenFunscripter-macOS-Intel.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: OFS-macOS-Intel
          path: OpenFunscripter-macOS-Intel.zip
          retention-days: 14
